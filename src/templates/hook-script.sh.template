#!/bin/bash

# CC Ring - Claude Code Sound Notifier Hook (macOS only)
# Auto-generated by VS Code extension
# Reads sound configuration from JSON file

CONFIG_FILE="{{CONFIG_PATH}}"
DEFAULT_SOUND="{{DEFAULT_SOUND_PATH}}"
DEFAULT_VOLUME="{{DEFAULT_VOLUME}}"
ERROR_LOG="{{ERROR_LOG_PATH}}"
HOOK_LOG="{{HOOK_LOG_PATH}}"

# Logging functions
log_error() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] ERROR: $1" >> "$ERROR_LOG" 2>/dev/null
    # Keep only last {{LOG_ROTATION_LINES}} lines
    if [[ -f "$ERROR_LOG" ]]; then
        tail -n {{LOG_ROTATION_LINES}} "$ERROR_LOG" > "$ERROR_LOG.tmp" 2>/dev/null && mv "$ERROR_LOG.tmp" "$ERROR_LOG" 2>/dev/null
    fi
}

log_info() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] INFO: $1" >> "$HOOK_LOG" 2>/dev/null
    # Keep only last {{LOG_ROTATION_LINES}} lines
    if [[ -f "$HOOK_LOG" ]]; then
        tail -n {{LOG_ROTATION_LINES}} "$HOOK_LOG" > "$HOOK_LOG.tmp" 2>/dev/null && mv "$HOOK_LOG.tmp" "$HOOK_LOG" 2>/dev/null
    fi
}

log_info "Hook execution started"

# Read config from JSON file
if [[ -f "$CONFIG_FILE" ]]; then
    log_info "Config file found: $CONFIG_FILE"
    # Extract soundPath and volume from JSON using basic parsing
    SOUND_FILE=$(grep -o '"soundPath"[[:space:]]*:[[:space:]]*"[^"]*"' "$CONFIG_FILE" 2>/dev/null | sed 's/.*"soundPath"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' 2>/dev/null)
    VOLUME=$(grep -o '"volume"[[:space:]]*:[[:space:]]*"[^"]*"' "$CONFIG_FILE" 2>/dev/null | sed 's/.*"volume"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/' 2>/dev/null)

    # Use defaults if extraction failed
    if [[ -z "$SOUND_FILE" ]]; then
        log_error "Failed to parse soundPath from config, using default"
        SOUND_FILE="$DEFAULT_SOUND"
    else
        log_info "Loaded soundPath: $SOUND_FILE"
    fi
    if [[ -z "$VOLUME" ]]; then
        log_error "Failed to parse volume from config, using default"
        VOLUME="$DEFAULT_VOLUME"
    else
        log_info "Loaded volume: $VOLUME"
    fi
else
    log_error "Config file not found: $CONFIG_FILE"
    # Config file doesn't exist, use defaults
    SOUND_FILE="$DEFAULT_SOUND"
    VOLUME="$DEFAULT_VOLUME"
    log_info "Using defaults: sound=$DEFAULT_SOUND, volume=$DEFAULT_VOLUME"
fi

# Fail fast if sound file doesn't exist
# TODO: Report errors via system notification
if [[ ! -f "$SOUND_FILE" ]]; then
    log_error "Sound file not found: $SOUND_FILE - hook execution failed"
    exit 1
fi

# Play sound using afplay
log_info "Playing sound: afplay -v $VOLUME $SOUND_FILE"
if ! afplay -v "$VOLUME" "$SOUND_FILE" &>/dev/null &
then
    log_error "Failed to play sound: afplay -v $VOLUME $SOUND_FILE"
else
    log_info "Sound played successfully"
fi

log_info "Hook execution completed"
exit 0
